<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#0a0806">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="No te olvides">
<title>No te olvides, Carlitos</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0806;
  --card: #131008;
  --card2: #1a1510;
  --border: #242018;
  --border2: #302a20;
  --rose: #d4906a;
  --rose2: #a06040;
  --rose3: #d4906a1a;
  --text: #f0ead8;
  --text2: #b0a490;
  --text3: #706050;
  --red: #c4503a;
}

* { margin:0; padding:0; box-sizing:border-box; }
html { scroll-behavior:smooth; }

body {
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  font-family: 'Cormorant Garamond', serif;
}

body::after {
  content:'';
  position:fixed; inset:0;
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='200' height='200' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events:none; z-index:9999;
}

.app { max-width: 800px; margin: 0 auto; padding: 0 24px 120px; }

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header { padding: 64px 0 48px; border-bottom: 1px solid var(--border2); }

.logo {
  font-family: 'Cormorant Garamond', serif;
  font-size: 48px; font-weight: 300;
  letter-spacing: -1px; color: var(--text);
  line-height: 1; margin-bottom: 8px;
}

.logo em { font-style: italic; color: var(--rose); }

.tagline {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px; letter-spacing: 3px;
  color: var(--text3); text-transform: uppercase;
}

.tagline em { color: var(--rose); font-style: normal; }

/* ‚îÄ‚îÄ SEC HEAD ‚îÄ‚îÄ */
.sec-head {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px; letter-spacing: 3px;
  text-transform: uppercase; color: var(--text3);
  margin: 36px 0 18px;
  display: flex; align-items: center; gap: 14px;
}

.sec-head::after { content:''; flex:1; height:1px; background:var(--border2); }

/* ‚îÄ‚îÄ PEOPLE LIST ‚îÄ‚îÄ */
.people-list { display: flex; flex-direction: column; gap: 2px; }

.person-card {
  background: var(--card); border: 1px solid var(--border);
  padding: 20px 24px; cursor: pointer; transition: all 0.2s;
  display: flex; align-items: center; gap: 20px;
  animation: fadeUp 0.3s ease;
}

.person-card:hover { border-color: var(--border2); background: var(--card2); }

.person-initial {
  width: 40px; height: 40px;
  background: var(--rose3); border: 1px solid var(--rose2);
  display: flex; align-items: center; justify-content: center;
  font-family: 'Cormorant Garamond', serif;
  font-size: 20px; font-weight: 300; color: var(--rose); flex-shrink: 0;
}

.person-card.empty .person-initial { background: transparent; border-color: var(--border2); color: var(--text3); }

.person-info { flex: 1; }

.person-name {
  font-family: 'Cormorant Garamond', serif;
  font-size: 22px; font-weight: 300; color: var(--text); margin-bottom: 4px;
}

.person-meta { font-family: 'JetBrains Mono', monospace; font-size: 9px; letter-spacing: 1px; color: var(--text3); }

.person-arrow { font-size: 16px; color: var(--text3); transition: color 0.2s; flex-shrink: 0; }
.person-card:hover .person-arrow { color: var(--rose); }

/* ‚îÄ‚îÄ ADD PERSON BTN ‚îÄ‚îÄ */
.add-person-btn {
  display: flex; align-items: center; gap: 14px;
  padding: 20px 24px; border: 1px dashed var(--border2);
  background: none; cursor: pointer; width: 100%; margin-top: 2px;
  transition: all 0.2s; color: var(--text3);
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px; letter-spacing: 2px; text-transform: uppercase;
}

.add-person-btn:hover { border-color: var(--rose2); color: var(--rose); }

.add-person-btn .plus {
  width: 40px; height: 40px; border: 1px solid var(--border2);
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; flex-shrink: 0; transition: border-color 0.2s;
}

.add-person-btn:hover .plus { border-color: var(--rose2); }

/* ‚îÄ‚îÄ PERSON VIEW ‚îÄ‚îÄ */
#person-view { display: none; animation: fadeUp 0.3s ease; }

.back-btn {
  font-family: 'JetBrains Mono', monospace; font-size: 9px; letter-spacing: 3px;
  color: var(--text3); background: none; border: none; cursor: pointer;
  text-transform: uppercase; margin-top: 40px; margin-bottom: 0;
  display: flex; align-items: center; gap: 8px; transition: color 0.2s; padding: 0;
}

.back-btn:hover { color: var(--rose); }

.person-header { padding: 32px 0 28px; border-bottom: 1px solid var(--border2); }

.person-header-name {
  font-family: 'Cormorant Garamond', serif;
  font-size: 42px; font-weight: 300; color: var(--text); line-height: 1.1; margin-bottom: 8px;
}

.person-header-meta { font-family: 'JetBrains Mono', monospace; font-size: 9px; letter-spacing: 2px; color: var(--text3); text-transform: uppercase; }

/* ‚îÄ‚îÄ CARLITOS ANALYSIS ‚îÄ‚îÄ */
.carlitos-analysis {
  margin-top: 32px; padding: 24px 28px;
  border-left: 2px solid var(--rose2); background: var(--rose3);
}

.ca-eyebrow { font-family: 'JetBrains Mono', monospace; font-size: 8px; letter-spacing: 3px; color: var(--rose2); text-transform: uppercase; margin-bottom: 12px; }

.ca-text { font-family: 'Cormorant Garamond', serif; font-size: 18px; font-weight: 300; font-style: italic; line-height: 1.7; color: var(--text2); }

.ca-text em { color: var(--rose); font-style: italic; }

/* ‚îÄ‚îÄ UPLOAD AREA ‚îÄ‚îÄ */
.upload-area {
  margin-top: 32px; border: 1px dashed var(--border2);
  padding: 28px; text-align: center; cursor: pointer;
  transition: all 0.2s; position: relative;
}

.upload-area:hover { border-color: var(--rose2); background: var(--rose3); }
.upload-area.dragover { border-color: var(--rose); background: var(--rose3); }

.upload-area input[type="file"] {
  position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%;
}

.upload-icon { font-size: 24px; margin-bottom: 10px; color: var(--text3); }

.upload-text { font-family: 'JetBrains Mono', monospace; font-size: 10px; letter-spacing: 2px; color: var(--text3); text-transform: uppercase; line-height: 1.8; }

.upload-text em { color: var(--rose); font-style: normal; }

/* ‚îÄ‚îÄ AUDIO LIST ‚îÄ‚îÄ */
.audio-list { margin-top: 28px; display: flex; flex-direction: column; gap: 2px; }

.audio-item {
  background: var(--card); border: 1px solid var(--border);
  padding: 16px 20px; display: flex; align-items: flex-start; gap: 16px;
}

.audio-date { font-family: 'JetBrains Mono', monospace; font-size: 9px; letter-spacing: 1px; color: var(--text3); white-space: nowrap; padding-top: 3px; flex-shrink: 0; min-width: 80px; }

.audio-content { flex: 1; }

.audio-transcript { font-size: 15px; font-weight: 300; color: var(--text2); line-height: 1.65; margin-bottom: 6px; font-style: italic; }

.audio-filename { font-family: 'JetBrains Mono', monospace; font-size: 8px; letter-spacing: 1px; color: var(--text3); }

.audio-processing { font-family: 'JetBrains Mono', monospace; font-size: 9px; letter-spacing: 1px; color: var(--rose2); animation: pulse 1.5s ease-in-out infinite; }

@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

/* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
.empty-state { margin-top: 48px; text-align: center; padding: 48px 24px; }

.empty-state-text { font-family: 'Cormorant Garamond', serif; font-size: 20px; font-weight: 300; font-style: italic; color: var(--text3); line-height: 1.8; }

/* ‚îÄ‚îÄ ADD MODAL ‚îÄ‚îÄ */
#add-modal { position: fixed; inset: 0; background: rgba(10,8,6,0.97); z-index: 9000; display: none; align-items: center; justify-content: center; padding: 40px; }
#add-modal.visible { display: flex; }

.add-modal-inner { max-width: 440px; width: 100%; animation: fadeUp 0.3s ease; }

.add-modal-title { font-family: 'Cormorant Garamond', serif; font-size: 32px; font-weight: 300; color: var(--text); margin-bottom: 8px; }

.add-modal-sub { font-family: 'JetBrains Mono', monospace; font-size: 10px; letter-spacing: 1px; color: var(--text3); margin-bottom: 32px; line-height: 1.7; }

.add-modal-input {
  width: 100%; background: var(--card); border: 1px solid var(--border2);
  padding: 16px 20px; font-family: 'Cormorant Garamond', serif;
  font-size: 22px; font-weight: 300; color: var(--text); outline: none;
  transition: border-color 0.2s; margin-bottom: 20px;
}

.add-modal-input:focus { border-color: var(--rose2); }
.add-modal-input::placeholder { color: var(--text3); font-style: italic; }

.add-modal-actions { display: flex; gap: 12px; align-items: center; }

.btn-rose { font-family: 'JetBrains Mono', monospace; font-size: 10px; letter-spacing: 2px; background: var(--rose); color: var(--bg); border: none; padding: 14px 28px; cursor: pointer; text-transform: uppercase; transition: opacity 0.2s; }
.btn-rose:hover { opacity: 0.85; }

.btn-cancel { font-family: 'JetBrains Mono', monospace; font-size: 9px; letter-spacing: 2px; color: var(--text3); background: none; border: none; cursor: pointer; text-transform: uppercase; transition: color 0.2s; }
.btn-cancel:hover { color: var(--text2); }

/* ‚îÄ‚îÄ ONBOARDING ‚îÄ‚îÄ */
#onboarding { position: fixed; inset: 0; background: var(--bg); z-index: 9800; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 48px; opacity: 0; transition: opacity 1.2s ease; }
#onboarding.visible { display: flex; }
#onboarding.faded { opacity: 1; }

.ob-text { font-family: 'Cormorant Garamond', serif; font-size: clamp(18px, 2.2vw, 24px); font-weight: 300; font-style: italic; line-height: 1.7; color: var(--text2); text-align: center; max-width: 520px; opacity: 0; transform: translateY(16px); transition: all 1s ease; }
.ob-text.s { opacity: 1; transform: translateY(0); }
.ob-text em { color: var(--rose); font-style: italic; }

.ob-btn { margin-top: 36px; font-family: 'JetBrains Mono', monospace; font-size: 11px; letter-spacing: 4px; color: var(--text3); background: none; border: 1px solid var(--border2); padding: 14px 36px; cursor: pointer; text-transform: uppercase; opacity: 0; transition: opacity 0.8s ease 2.5s; }
.ob-btn.s { opacity: 1; }
.ob-btn:hover { color: var(--rose); border-color: var(--rose2); }

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast { position: fixed; bottom: 32px; left: 50%; transform: translateX(-50%); background: var(--card2); border: 1px solid var(--border2); font-family: 'JetBrains Mono', monospace; font-size: 10px; letter-spacing: 1px; color: var(--text2); padding: 12px 24px; z-index: 9990; white-space: nowrap; animation: toastIn 0.3s ease; }
@keyframes toastIn { from{opacity:0;transform:translateX(-50%) translateY(8px)} to{opacity:1;transform:translateX(-50%) translateY(0)} }
@keyframes toastOut { from{opacity:1} to{opacity:0} }
@keyframes fadeUp { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }

/* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
.site-footer { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg); border-top: 1px solid var(--border); padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; z-index: 100; }
.footer-note { font-family: 'JetBrains Mono', monospace; font-size: 8px; letter-spacing: 1px; color: var(--text3); }
.footer-btn { font-family: 'JetBrains Mono', monospace; font-size: 9px; letter-spacing: 2px; color: var(--text3); background: none; border: none; cursor: pointer; text-transform: uppercase; transition: color 0.2s; }
.footer-btn.rose { color: var(--rose); }
.footer-btn.rose:hover { opacity: 0.8; }
</style>
</head>
<body>

<!-- ONBOARDING -->
<div id="onboarding">
  <div class="ob-text" id="ob-text">
    Carlitos no va a preguntar qui√©n es.<br><br>
    Sub√≠ los audios. √âl escucha todo ‚Äî lo que dijeron hoy, lo que dijeron hace a√±os, lo que repitieron sin darse cuenta.<br><br>
    Tu abuela Rosa cont√≥ la misma historia del pueblo doce veces.<br>
    Cada vez cambi√≥ un detalle.<br><br>
    <em>Carlitos lo not√≥.</em>
  </div>
  <button class="ob-btn" id="ob-btn" onclick="dismissOnboarding()">‚Üí</button>
</div>

<!-- ADD PERSON MODAL -->
<div id="add-modal">
  <div class="add-modal-inner">
    <div class="add-modal-title">¬øQui√©n es?</div>
    <div class="add-modal-sub">Pod√©s usar el nombre, el apodo, lo que sea.<br>Carlitos va a reconocerlo as√≠.</div>
    <input class="add-modal-input" id="person-name-input" placeholder="Mam√°, Abuela Rosa, Pap√°..."
      maxlength="40" onkeydown="if(event.key==='Enter')savePerson()">
    <div class="add-modal-actions">
      <button class="btn-rose" onclick="savePerson()">Agregar</button>
      <button class="btn-cancel" onclick="closeAddModal()">Cancelar</button>
    </div>
  </div>
</div>

<div class="app">

  <!-- HOME VIEW -->
  <div id="home-view">
    <header>
      <div class="logo">No te olvides, <em>Carlitos.</em></div>
      <div class="tagline">√âl guarda <em>su voz.</em></div>
    </header>

    <div class="sec-head">Personas</div>
    <div class="people-list" id="people-list"></div>
    <button class="add-person-btn" onclick="showAddModal()">
      <div class="plus">+</div>
      Agregar persona
    </button>
  </div>

  <!-- PERSON VIEW -->
  <div id="person-view">
    <button class="back-btn" onclick="goHome()">‚Üê Volver</button>

    <div class="person-header">
      <div class="person-header-name" id="pv-name"></div>
      <div class="person-header-meta" id="pv-meta"></div>
    </div>

    <div class="carlitos-analysis" id="pv-analysis" style="display:none">
      <div class="ca-eyebrow">Carlitos dice</div>
      <div class="ca-text" id="pv-analysis-text"></div>
    </div>

    <div class="upload-area" id="upload-area">
      <input type="file" accept="audio/*" multiple id="audio-input" onchange="handleAudioUpload(event)">
      <div class="upload-icon">üéô</div>
      <div class="upload-text">
        Arrastr√° audios o toc√° para elegir<br>
        <em>WhatsApp ¬∑ notas de voz ¬∑ cualquier audio</em>
      </div>
    </div>

    <div class="audio-list" id="audio-list"></div>

    <div class="empty-state" id="empty-state">
      <div class="empty-state-text">
        Todav√≠a no hay audios.<br>
        Cuando agregues el primero,<br>
        Carlitos empieza a escuchar.
      </div>
    </div>
  </div>

</div>

<footer class="site-footer">
  <span class="footer-note">Lo que sub√≠s lo escucha Carlitos, no su creador ¬∑ Datos guardados localmente</span>
  <button class="footer-btn rose" id="add-btn" onclick="showAddModal()">+ Persona</button>
</footer>

<script>
const SK = 'ymama_v1';
let state = JSON.parse(localStorage.getItem(SK) || 'null') || {
  people: {}, onboardingDone: false,
  usage: { month: null, calls: 0 },
  isPro: false
};
if (!state.usage) state.usage = { month: null, calls: 0 };
if (state.isPro === undefined) state.isPro = false;

let currentPersonId = null;

function save() { localStorage.setItem(SK, JSON.stringify(state)); }

// ‚îÄ‚îÄ SOFT LIMITS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const LIMITS = { free: 30, pro: 200 };

function getUsageMonth() {
  const now = new Date();
  return `${now.getFullYear()}-${now.getMonth()}`;
}

function trackCall() {
  const month = getUsageMonth();
  if (state.usage.month !== month) state.usage = { month, calls: 0 };
  state.usage.calls++;
  save();
}

function checkLimit() {
  const month = getUsageMonth();
  if (state.usage.month !== month) return { ok: true, calls: 0 };
  const limit = state.isPro ? LIMITS.pro : LIMITS.free;
  const calls = state.usage.calls;
  if (calls >= limit) return { ok: false, calls, limit };
  if (calls >= limit * 0.85) return { ok: true, calls, limit, warning: true };
  return { ok: true, calls };
}

function showLimitWarning(calls, limit) {
  showToast(`A Carlitos le quedan ${limit - calls} transcripci√≥n${limit - calls !== 1 ? 'es' : ''} este mes.`);
}

function showLimitBlocked(limit) {
  showToast(state.isPro
    ? `Llegaste al l√≠mite de ${limit} transcripciones mensuales. Se reinicia el mes que viene.`
    : `L√≠mite gratuito alcanzado. Activ√° Pro para seguir subiendo audios.`
  );
}

// ‚îÄ‚îÄ ONBOARDING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function checkOnboarding() {
  if (state.onboardingDone) return;
  const o = document.getElementById('onboarding');
  o.classList.add('visible');
  requestAnimationFrame(() => {
    setTimeout(() => {
      o.classList.add('faded');
      setTimeout(() => document.getElementById('ob-text').classList.add('s'), 300);
      setTimeout(() => document.getElementById('ob-btn').classList.add('s'), 2200);
    }, 50);
  });
}

function dismissOnboarding() {
  const o = document.getElementById('onboarding');
  o.classList.remove('faded');
  setTimeout(() => { o.classList.remove('visible'); o.style.display = 'none'; }, 1200);
  state.onboardingDone = true;
  save();
}

// ‚îÄ‚îÄ PEOPLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderPeople() {
  const list = document.getElementById('people-list');
  const ids = Object.keys(state.people);
  if (!ids.length) { list.innerHTML = ''; return; }
  list.innerHTML = ids.map(id => {
    const p = state.people[id];
    const count = (p.audios || []).length;
    const meta = count === 0 ? 'Sin audios todav√≠a' : `${count} audio${count !== 1 ? 's' : ''}${p.lastAdded ? ' ¬∑ √∫ltimo: ' + p.lastAdded : ''}`;
    return `<div class="person-card ${count === 0 ? 'empty' : ''}" onclick="openPerson('${id}')">
      <div class="person-initial">${p.name.charAt(0).toUpperCase()}</div>
      <div class="person-info">
        <div class="person-name">${p.name}</div>
        <div class="person-meta">${meta}</div>
      </div>
      <div class="person-arrow">‚Üí</div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ ADD PERSON ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showAddModal() {
  document.getElementById('add-modal').classList.add('visible');
  setTimeout(() => document.getElementById('person-name-input').focus(), 100);
}

function closeAddModal() {
  document.getElementById('add-modal').classList.remove('visible');
  document.getElementById('person-name-input').value = '';
}

function savePerson() {
  const name = document.getElementById('person-name-input').value.trim();
  if (!name) return;
  const id = 'p_' + Date.now();
  state.people[id] = { name, audios: [], analysis: null, lastAdded: null };
  save();
  closeAddModal();
  renderPeople();
  openPerson(id);
}

// ‚îÄ‚îÄ PERSON VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openPerson(id) {
  currentPersonId = id;
  const p = state.people[id];
  document.getElementById('home-view').style.display = 'none';
  document.getElementById('person-view').style.display = 'block';
  document.getElementById('add-btn').style.display = 'none';
  document.getElementById('pv-name').textContent = p.name;
  renderPersonMeta(p);
  renderAnalysis(p);
  renderAudios(p);
}

function renderPersonMeta(p) {
  const count = (p.audios || []).length;
  document.getElementById('pv-meta').textContent = count === 0
    ? 'Sin audios todav√≠a'
    : `${count} audio${count !== 1 ? 's' : ''}${p.lastAdded ? ' ¬∑ √∫ltimo: ' + p.lastAdded : ''}`;
}

function renderAnalysis(p) {
  const el = document.getElementById('pv-analysis');
  if (p.analysis) {
    document.getElementById('pv-analysis-text').innerHTML = p.analysis;
    el.style.display = 'block';
  } else {
    el.style.display = 'none';
  }
}

function renderAudios(p) {
  const list = document.getElementById('audio-list');
  const empty = document.getElementById('empty-state');
  const audios = p.audios || [];
  if (!audios.length) { list.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';
  list.innerHTML = [...audios].reverse().map(a => `
    <div class="audio-item">
      <div class="audio-date">${a.date}</div>
      <div class="audio-content">
        ${a.processing
          ? `<div class="audio-processing">Carlitos est√° escuchando...</div>`
          : `<div class="audio-transcript">"${a.transcript}"</div>`}
        <div class="audio-filename">${a.filename}</div>
      </div>
    </div>`).join('');
}

function goHome() {
  currentPersonId = null;
  document.getElementById('person-view').style.display = 'none';
  document.getElementById('home-view').style.display = 'block';
  document.getElementById('add-btn').style.display = 'block';
  renderPeople();
}

// ‚îÄ‚îÄ AUDIO COMPRESSION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function compressAudio(file) {
  try {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
    const arrayBuffer = await file.arrayBuffer();
    const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

    // Mezclar a mono y re-samplear a 16kHz
    const offlineCtx = new OfflineAudioContext(1, audioBuffer.duration * 16000, 16000);
    const source = offlineCtx.createBufferSource();
    source.buffer = audioBuffer;
    source.connect(offlineCtx.destination);
    source.start();

    const rendered = await offlineCtx.startRendering();
    await audioCtx.close();

    // Convertir a WAV
    const wav = audioBufferToWav(rendered);
    return new File([wav], file.name.replace(/\.[^.]+$/, '.wav'), { type: 'audio/wav' });
  } catch(e) {
    // Si falla la compresi√≥n, devolver el original
    console.warn('Compresi√≥n fall√≥, usando original:', e);
    return file;
  }
}

function audioBufferToWav(buffer) {
  const numChannels = 1;
  const sampleRate = buffer.sampleRate;
  const samples = buffer.getChannelData(0);
  const dataLength = samples.length * 2;
  const wavBuffer = new ArrayBuffer(44 + dataLength);
  const view = new DataView(wavBuffer);

  // WAV header
  const writeStr = (offset, str) => { for (let i = 0; i < str.length; i++) view.setUint8(offset + i, str.charCodeAt(i)); };
  writeStr(0, 'RIFF');
  view.setUint32(4, 36 + dataLength, true);
  writeStr(8, 'WAVE');
  writeStr(12, 'fmt ');
  view.setUint32(16, 16, true);
  view.setUint16(20, 1, true); // PCM
  view.setUint16(22, numChannels, true);
  view.setUint32(24, sampleRate, true);
  view.setUint32(28, sampleRate * numChannels * 2, true);
  view.setUint16(32, numChannels * 2, true);
  view.setUint16(34, 16, true);
  writeStr(36, 'data');
  view.setUint32(40, dataLength, true);

  // Samples
  let offset = 44;
  for (let i = 0; i < samples.length; i++) {
    const s = Math.max(-1, Math.min(1, samples[i]));
    view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
    offset += 2;
  }

  return new Blob([wavBuffer], { type: 'audio/wav' });
}

// ‚îÄ‚îÄ AUDIO UPLOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function handleAudioUpload(event) {
  const files = Array.from(event.target.files);
  if (!files.length || !currentPersonId) return;

  // Verificar l√≠mite antes de procesar
  const limitCheck = checkLimit();
  if (!limitCheck.ok) {
    showLimitBlocked(limitCheck.limit);
    event.target.value = '';
    return;
  }

  const p = state.people[currentPersonId];

  for (const file of files) {
    const audioId = 'a_' + Date.now() + '_' + Math.random().toString(36).slice(2);
    const dateStr = new Date().toLocaleDateString('es-AR', { day:'numeric', month:'short', year:'numeric' });
    p.audios.push({ id: audioId, filename: file.name, date: dateStr, transcript: '', processing: true });
    p.lastAdded = 'hoy';
    save();
    renderAudios(p);
    renderPersonMeta(p);

    try {
      const compressed = await compressAudio(file);
      const transcript = await transcribeAudio(compressed);
      const idx = p.audios.findIndex(a => a.id === audioId);
      if (idx !== -1) { p.audios[idx].transcript = transcript; p.audios[idx].processing = false; }
      trackCall();
      const afterCheck = checkLimit();
      if (afterCheck.warning) showLimitWarning(afterCheck.calls, afterCheck.limit);
      save();
      renderAudios(p);
      if (p.audios.filter(a => !a.processing).length >= 2) await updateAnalysis(p);
    } catch(e) {
      const idx = p.audios.findIndex(a => a.id === audioId);
      if (idx !== -1) { p.audios[idx].transcript = '[No se pudo transcribir]'; p.audios[idx].processing = false; }
      save();
      renderAudios(p);
    }
  }
  event.target.value = '';
}

async function transcribeAudio(file) {
  const base64 = await new Promise((res, rej) => {
    const r = new FileReader();
    r.onload = () => res(r.result.split(',')[1]);
    r.onerror = rej;
    r.readAsDataURL(file);
  });

  const response = await fetch("/api/proxy", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      model: "claude-sonnet-4-6",
      max_tokens: 1000,
      messages: [{
        role: "user",
        content: [
          { type: "document", source: { type: "base64", media_type: file.type || 'audio/mp4', data: base64 } },
          { type: "text", text: "Transcrib√≠ este audio exactamente como se escucha. Solo el texto, sin comentarios. Si no se entiende algo, us√° [...]. Solo la transcripci√≥n." }
        ]
      }]
    })
  });

  const data = await response.json();
  return data.content?.map(i => i.text || '').join('') || '[Sin transcripci√≥n]';
}

async function updateAnalysis(p) {
  const transcripts = p.audios
    .filter(a => !a.processing && a.transcript && a.transcript !== '[No se pudo transcribir]')
    .map((a, i) => `Audio ${i+1} (${a.date}):\n"${a.transcript}"`)
    .join('\n\n');
  if (!transcripts) return;

  try {
    const response = await fetch("/api/proxy", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "claude-sonnet-4-6",
        max_tokens: 150,
        messages: [{
          role: "user",
          content: `Sos Carlitos. Escuchaste estos audios de "${p.name}".

TONO: Como alguien que escuch√≥ todo con atenci√≥n y nota algo que la persona que subi√≥ los audios no vio sola. Directo, sin anestesia, sin coaching. Pon√©s los hechos juntos y los dej√°s sonar. M√°s cuidado que en el diario ‚Äî estos son recuerdos, no confesiones.

Us√° <em> para las palabras que m√°s pesan. M√°x 40 palabras. Una sola observaci√≥n. Sin preguntas al final.

AUDIOS:
${transcripts}

Solo el texto.`
        }]
      })
    });
    const data = await response.json();
    const text = data.content?.map(i => i.text || '').join('') || '';
    if (text) { p.analysis = text; save(); renderAnalysis(p); }
  } catch(e) {}
}

// ‚îÄ‚îÄ DRAG & DROP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const uploadArea = document.getElementById('upload-area');
uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('dragover'); });
uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
uploadArea.addEventListener('drop', e => {
  e.preventDefault();
  uploadArea.classList.remove('dragover');
  const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('audio/'));
  if (files.length) {
    const dt = new DataTransfer();
    files.forEach(f => dt.items.add(f));
    document.getElementById('audio-input').files = dt.files;
    handleAudioUpload({ target: document.getElementById('audio-input') });
  }
});

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showToast(msg) {
  const ex = document.querySelector('.toast');
  if (ex) ex.remove();
  const t = document.createElement('div');
  t.className = 'toast'; t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => { t.style.animation='toastOut 0.3s ease forwards'; setTimeout(()=>t.remove(),300); }, 3000);
}

// ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
checkOnboarding();
renderPeople();
</script>
</body>
</html>
